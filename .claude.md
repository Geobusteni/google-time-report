# Google Time Report - Project Instructions

## Development Principles

### CRITICAL RULES - MUST FOLLOW
- **DO NOT ASSUME** - Never assume anything. If unclear, ask or verify.
- **DO NOT HALLUCINATE** - Only use real APIs, real methods, real syntax that exists in Google Apps Script.
- **KEEP IT DRY** - Don't Repeat Yourself. No duplicate code. No redundant logic.
- **KEEP IT SIMPLE** - Always choose the simplest solution. No over-engineering.
- **VERIFY EVERYTHING** - Check that APIs exist, methods are correct, syntax is valid.

### Development Workflow
1. **Product Manager Agent** - Plans the development tasks, defines requirements, prioritizes work
2. **Senior Developer Agents (x2)** - Implement the plan in parallel where possible

### Code Quality Rules
- Write minimal, focused code
- One function = one purpose
- No speculative features
- No "nice to have" additions
- Test every assumption against Google Apps Script documentation

### Git Configuration
- Author Name: Alexandru Negoita
- Author Email: hi@kul.site

## Project Overview

This is a **standalone Google Apps Script project** (not a Workspace Add-on) that generates monthly time reports from Google Calendar events. It's designed to work with **personal Google accounts** - no Google Workspace subscription required.

The script filters calendar events starting with project codes (e.g., `#193IQTIG`), computes hours, and writes structured reports to Google Sheets.

## Important: Personal Account Compatibility

This project is built as a **container-bound script** (script attached to a Google Sheet) rather than a Google Workspace Add-on because:

1. **Workspace Add-ons require organizational deployment** - not available for personal `@gmail.com` accounts
2. **Container-bound scripts work with any Google account** - free, immediate, no approval process
3. **Simpler deployment** - just copy the code into a Google Sheet's script editor
4. **Same functionality** - custom menus, sidebars, triggers all work identically

## Project Structure

```
google-time-report/
├── .claude.md                 # This file - project instructions
├── src/
│   ├── appsscript.json       # Manifest with OAuth scopes
│   ├── Code.gs               # Main entry point and menu/trigger setup
│   ├── CalendarService.gs    # Calendar API integration and event fetching
│   ├── SheetService.gs       # Google Sheets creation and writing logic
│   ├── ReportGenerator.gs    # Core reporting algorithm and data processing
│   ├── Utils.gs              # Utility functions (date formatting, timezone)
│   └── Sidebar.html          # Sidebar UI with HTMLService
├── docs/
│   └── DEPLOYMENT.md         # Deployment and configuration instructions
└── README.md                 # Project documentation
```

## Deployment Method

### Container-Bound Script (Recommended for Personal Accounts)

1. Create a new Google Sheet
2. Go to Extensions → Apps Script
3. Copy all `.gs` files into the script editor
4. Copy `Sidebar.html` as an HTML file
5. Update `appsscript.json` in Project Settings
6. Save and authorize when prompted
7. Refresh the spreadsheet to see the custom menu

### No Publishing Required
- Scripts work immediately after authorization
- No marketplace listing needed
- No domain admin approval required
- Works with any `@gmail.com` account

## Technical Requirements

### Google Apps Script Standards
- Use modern JavaScript syntax: `const`, `let`, arrow functions
- All code must run unmodified in Google Apps Script environment
- Use `Session.getScriptTimeZone()` for timezone handling
- Handle errors gracefully with try/catch blocks
- Include JSDoc comments for all functions

### Required OAuth Scopes (declared in appsscript.json)
- `https://www.googleapis.com/auth/calendar.readonly` - Read calendar events
- `https://www.googleapis.com/auth/spreadsheets` - Create and write to sheets
- `https://www.googleapis.com/auth/script.container.ui` - Show sidebar UI

### Event Filtering Rules
- Only process events whose title starts with `#` followed by a project code
- Extract project code using regex: `^#(\S+)`
- Ignore all-day events
- Ignore events with zero duration
- Respect user's timezone settings

### Data Processing Algorithm
1. Determine date range (first to last day of target month)
2. Fetch all calendar events in that range
3. Filter events starting with `#`
4. Extract project code (characters after `#` until next whitespace)
5. Compute duration: `(endTime - startTime) / (1000 * 60 * 60)`
6. Normalize data to standard formats
7. Sort by: Code → Date → Start time
8. Write to Report sheet
9. Generate Totals sheet with aggregated data

### Sheet Structure

**Sheet 1: Report**
| Date | Code | Title | Start | End | Hours |
|------|------|-------|-------|-----|-------|

**Sheet 2: Totals**
| Code | Total Hours |
|------|-------------|
| (Grand Total row at bottom) |

### Spreadsheet Naming Convention
- Create new spreadsheet each month: `Time Report – YYYY-MM`
- Clear and regenerate sheets on every run

## Code Style Guidelines

### Naming Conventions
- Functions: `camelCase` (e.g., `fetchCalendarEvents`)
- Constants: `UPPER_SNAKE_CASE` (e.g., `PROJECT_CODE_REGEX`)
- Classes/Services: `PascalCase` (e.g., `CalendarService`)

### Function Documentation
```javascript
/**
 * Brief description of what the function does.
 * @param {Type} paramName - Description of parameter
 * @returns {Type} Description of return value
 * @throws {Error} Description of when errors are thrown
 */
```

### Error Handling
- Wrap API calls in try/catch blocks
- Log errors using `console.error()` or `Logger.log()`
- Provide user-friendly error messages in the UI
- Never let errors crash silently

### Modularity
- Each `.gs` file should have a single responsibility
- Use dependency injection where appropriate
- Keep functions small and focused (max ~50 lines)

## UI Requirements

### Custom Menu (in Google Sheets)
- Menu name: "Time Reporting"
- Menu items:
  - "Generate Monthly Report" - Opens sidebar
  - "Generate Current Month" - Quick generate
  - "Setup Monthly Trigger" - Configure automation
  - "Remove All Triggers" - Cleanup

### Sidebar Components
- Title: "Time Report Generator"
- Button: "Generate Time Report" (primary action)
- Date range selector: Year and Month dropdowns
- Status area for logs/messages
- Loading indicator during generation

### HTMLService Guidelines
- Use `HtmlService.createHtmlOutputFromFile()`
- Include inline CSS for styling (no external stylesheets)
- Use `google.script.run` for server communication
- Handle success/failure callbacks properly
- Use Google's CSS for consistent styling

## Automation/Triggers

### Supported Triggers
- **Manual**: Via menu or sidebar button
- **Monthly**: Run at 00:05 on the 1st of each month
- **Daily/Weekly**: Configurable additional triggers

### Trigger Setup (Installable Triggers)
```javascript
ScriptApp.newTrigger('generateMonthlyReportTrigger')
  .timeBased()
  .onMonthDay(1)
  .atHour(0)
  .nearMinute(5)
  .create();
```

Note: Installable triggers work with personal accounts and persist even when the spreadsheet is closed.

## Testing Guidelines

- Test with various calendar event formats
- Test timezone handling across different user timezones
- Test edge cases: empty calendars, no matching events, very long event titles
- Test spreadsheet creation when no existing sheet exists
- Verify proper handling of multi-day events
- Test with personal `@gmail.com` accounts

## Deployment Checklist (Personal Account)

1. Open Google Sheets and create a new spreadsheet
2. Go to Extensions → Apps Script
3. Delete any default code in Code.gs
4. Copy contents of each `.gs` file into separate script files
5. Create new HTML file and copy Sidebar.html content
6. Click Project Settings (gear icon)
7. Check "Show appsscript.json manifest file"
8. Update appsscript.json with the manifest content
9. Save all files (Ctrl+S)
10. Close script editor and refresh the spreadsheet
11. Click "Time Reporting" menu → "Generate Monthly Report"
12. Authorize the script when prompted
13. (Optional) Set up triggers via menu

## Common Issues and Solutions

### "Authorization required" errors
- Click the menu item again after authorizing
- If scopes change, re-authorize by running any function from the script editor

### Timezone mismatches
- Always use `Session.getScriptTimeZone()` or `CalendarApp.getDefaultCalendar().getTimeZone()`
- Format dates using `Utilities.formatDate()` with explicit timezone

### Missing events
- Check date range boundaries (start of day vs end of day)
- Verify the default calendar is being used
- Check event visibility settings

### "Script not authorized" for personal account
- This is normal on first run
- Click through the "Advanced" → "Go to [project name]" flow
- Grant calendar and sheets permissions

## Do NOT

- Do NOT use pseudocode or partial examples
- Do NOT use deprecated Apps Script APIs
- Do NOT hardcode timezone values
- Do NOT skip error handling
- Do NOT create unnecessary files or over-engineer
- Do NOT add features beyond the specification
- Do NOT mention Claude as co-author in commits
- Do NOT use Workspace Add-on features (cards, homepageTrigger) - use container-bound script features only
- Do NOT ASSUME anything - verify all assumptions
- Do NOT HALLUCINATE - only use real, verified APIs and methods
- Do NOT repeat code - keep it DRY
- Do NOT over-complicate - simple solutions only

## Important Notes

- All code must be copy-paste ready for Google Apps Script
- The solution must work end-to-end without modifications
- Follow the specification literally and completely
- Prioritize reliability over cleverness
- This MUST work with personal Google accounts (@gmail.com)
- Use container-bound script pattern, NOT Workspace Add-on pattern
- VERIFY all Google Apps Script APIs exist before using them
- SIMPLE is better than clever
